* [Cookie](#cookie)
    + [쿠키 옵션](#쿠키-옵션)
        + [Domain](#1-domain---서버와-요청의-도메인이-일치하는-경우-쿠키-전송)
        + [Path](#2-path---서버의-요청의-세부-경로가-일치하는-경우-쿠키-전송)
        + [MaxAge or Expires](#3-maxage-or-expires---쿠키의-유효기간-설정)
        + [Secure](#4-secure---https에서만-쿠키-전송-여부-설정)
        + [HttpOnly](#5-httponly---스크립트의-쿠키-접근-가능-여부-설정)
        + [SameSite](#6-samesite---같은-사이트에서만-쿠키를-사용할-수-있게하는-설정)
    + [쿠키를 이용한 상태 유지](#쿠키를-이용한-상태-유지)

# Cookie

> 쿠키는 서버에서 클라이언트에 데이터를 저장하는 방법 중 하나이다.
> 
- 쿠키를 이용하는 것은 단순히 서버에서 클라이언트에 쿠키를 전송하는 것만이 아니라 클라이언트에서 서버로 쿠키를 전송하는 것도 포함된다.
- 하지만 데이터를 저장한 이후 아무 때나 데이터를 가져올 수 없다. 데이터를 저장한 이후 특정 조건들을 만족하는 경우에만 다시 가져올 수 있다.
- 이런 조건들은 쿠키 옵션으로 표현할 수 있다.

## 쿠키 옵션

### 1. Domain - 서버와 요청의 도메인이 일치하는 경우 쿠키 전송

- 도메인이란 `[www.google.com](http://www.google.com)` 과 같은 서버에 접속할 수 있는 이름이다.
- 쿠키 옵션에서 도메인은 포트 및 서브 도메인 정보, 세부 경로를 포함하지 않는다. 서브 도메인이란 `www` 같은 도메인 앞에 추가로 작성되는 부분을 말한다.
- 요청해야 할 URL `[http://www.localhost.com:3000/users/login](http://www.localhost.com:3000/users/login)` 이라면, Domain은 `localhost.com` 이 된다.
- 만약 쿠키 옵션에서 도메인 정보가 존재한다면 클라이언트에서는 쿠키의 도메인 옵션과 서버의 도메인이 일치해야만 쿠키를 전송할 수 있다. 이를 통해 `[naver.com](http://naver.com)` 에서 받은 쿠키를 `[google.com](http://google.com)` 에 전송하는 일을 막을 수 있다.

### 2. Path - 서버의 요청의 세부 경로가 일치하는 경우 쿠키 전송

- 세부 경로는 서버가 라우팅할 때 사용하는 경로이다.
- 요청해야 하는 URL이 `[http://www.localhost.com:3000/users/login](http://www.localhost.com:3000/users/login)` 인 경우라면 여기에 path, 세부 경로는 `/users/login` 이 된다.
- path를 명시하지 않으면 기본으로 `/` 으로 설정되어 있다.
- Path 옵션의 특징으로는 설정된 path를 만족하는 경우 요청하는 Path가 추가로 더 존재하더라도 쿠키를 서버에 전송할 수 있다.
    - path가 `/users` 로 설정되어 있고, 요청하는 세부 경로가 `/users/coupon` 인 경우라면 쿠키 전송이 가능하다.
    - 하지만 `/post/coupon` 로 전송되는 요청은 Path 옵션 `/users` 를 만족하지 못하기 때문에 서버로 쿠키를 전송할 수 없다.

### 3. MaxAge or Expires - 쿠키의 유효기간 설정

- 쿠키가 유효한 기간을 정하는 옵션이다.
- 만약 쿠키가 영원히 남아있다면 그만큼 탈취되기도 쉬워지기 때문에 이러한 유효기간을 설정하는 것이 보안 측면에서 중요하다.
- MaxAge : 앞으로 몇 초 동안 쿠키가 유효한지 설정하는 옵션
- Expires : 언제까지 유효한지 `Date` 를 지정하는 옵션. 이 때 클라이언트의 시간을 기준으로 한다. 이후 지정된 시간, 날짜를 초과하게 되면 쿠키는 자동으로 파괴된다.
- 쿠키는 위 옵션의 여부에 따라 세션 쿠키(Session Cookie)와 영속성 쿠키(Persistent Cookie)로 나눠진다.
    - 세션 쿠키 : MaxAge 또는 Expires 옵션이 없는 쿠키. 브라우저가 실행 중일 때 사용할 수 있는 임시 쿠키이다. 브라우저를 종료하면 해당 쿠키는 삭제된다.
    - 영속성 쿠키 : 브라우저의 종료 여부와 상관없이 MaxAge 또는 Expires에 지정된 유효시간만큼 사용 가능한 쿠키

### 4. Secure - HTTPS에서만 쿠키 전송 여부 설정

- 쿠키를 전송해야 할 때 사용하는 프로토콜에 따른 쿠키 전송 여부를 결정한다.
- Secoure 옵션이 `true` 로 설정된 경우, HTTPS 프로토콜을 이용하여 통신하는 경우에만 쿠키를 전송할 수 있다.
- Secure 옵션이 없다면 프로토콜에 상관없이 `[http://www.google.com](http://www.google.com)` 또는 `[https://www.google.com](https://www.google.com)` 에 모두 쿠키를 전송할 수 있다.

### 5. HttpOnly - 스크립트의 쿠키 접근 가능 여부 설정

- 자바스크립트에서 브라우저의 쿠키에 접근 여부를 결정한다.
- HttpOnly 옵션이 `true` 로 설정될 경우, 자바스크립트에서는 쿠키에 접근이 불가하다.
- 명시되지 않는 경우 기본으로 `false` 로 지정되어 있다.
- 옵션이 `false` 인 경우 자바스크립트에서 쿠키에 접근이 가능하므로 XSS 공격에 취약하다.

### 6. SameSite - 같은 사이트에서만 쿠키를 사용할 수 있게하는 설정

- Cross-Origin 요청을 받은 경우 요청에서 사용한 메소드와 해당 옵션(e.g. `GET` , `POST` , `PUT` , `PATCH` …)의 조합으로 서버의 쿠키 전송 여부를 결정하게 된다.
    - Lax : Cross-Origin 요청이면 `GET` 메소드에 대해서만 쿠키를 전송할 수 있다.
    - Strict : Cross-Origin이 아닌 `same-site` 인 경우에만 쿠키를 전송할 수 있다.
    - None : 항상 쿠키를 보내줄 수 있다. 다만 쿠키 옵션 중 `Secure` 옵션이 필요하다.
- `same-site` 는 요청을 보낸 Origin과 서버의 도메인, 프로토콜, 포트가 같은 경우를 말한다. 이 중 하나라도 다르다면 Cross-Origin으로 구분된다.
- 이러한 옵션들을 지정한 다음 서버에서 클라이언트로 쿠키를 처음 전송하게 된다면 헤더에 `Set-Cookie` 라는 프로퍼티에 쿠키를 담아 쿠키를 전송하게 된다.
- 이후 클라이언트 혹은 서버에서 쿠키를 전송해야 한다면 클라이언트는 헤더에 `Cookie` 라는 프로퍼티에 쿠키를 담아 서버에 쿠키를 전송하게 된다.

## 쿠키를 이용한 상태 유지

- 서버는 클라이언트에 인증정보를 담은 쿠키를 전송하고, 클라이언트는 전달받은 쿠키를 요청과 같이 전송하여 Stateless한 인터넷 연결을 Stateful하게 유지할 수 있다.
- **하지만 기본적으로 쿠키는 오랜 시간 동안 유지될 수 있고, 자바스크립트를 이용해서 쿠키에 접근할 수 있기 때문에 쿠키에 민감한 정보를 담는 것은 위험하다.**
- 인증정보를 탈취해서 서버에 요청을 보낸다면 서버는 누가 요청을 보낸건지 상관하지 않고 인증된 유저의 요청으로 취급하기 때문에 개인 유저 정보 같은 민감한 정보에 접근이 가능하다.